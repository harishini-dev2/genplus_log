{% load static %}
{% include 'includes/includes_admin/headers.html' %}
{% include 'includes/includes_admin/sidebar.html' %}
{% include 'includes/includes_admin/navbar.html' %}
<!-- Content Here -->

<div class="page-wrapper">
    <div class="page-content">
        <div class="dash-wrapper">
            <div class="page-breadcrumb d-none d-sm-flex align-items-centers-center mb-3">
                <div class="breadcrumb-title pe-3">Masters</div>
                <div class="ps-3">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0 p-0">
                            <li class="breadcrumb-item"><a href="javascript:;"><i class="bx bx-home-alt"></i></a></li>
                            <li class="breadcrumb-item active" aria-current="page">Company</li>
                        </ol>
                    </nav>
                </div>               
            </div> 

            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Add Company Details </h5>
                </div>
       
               <div class="card-body">                                        
                     <form class="row g-3" id="edit_form" enctype="multipart/form-data">
                        {% csrf_token %}                                                         
                       <div class="col-md-6 mb-1">
                            <label for="name" class="form-label"><span style="color: red;">*</span> Company Name </label>
                            <input type="text" class="form-control" name="name" id="name">
                        </div>

                        <div class="col-md-6 mb-1">
                            <label for="prefix" class="form-label"><span style="color: red;">*</span> Prefix </label>
                            <input type="text" class="form-control" id="prefix" name="prefix">
                        </div>
                        <div class="col-md-6 mb-1">
                            <label for="address1" class="form-label">Address Line 1</label>
                            <textarea class="form-control" id="address_line1" placeholder="Address..." rows="3" name="address_line1"></textarea>
                        </div>
                        <div class="col-md-6 mb-1">
                            <label for="address2" class="form-label">Address Line 2</label>
                            <textarea class="form-control" id="address_line2" placeholder="Address..." rows="3" name="address_line2"></textarea>
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="city" class="form-label">City</label>
                            <input type="text" class="form-control" id="city" name="city" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="state" class="form-label">State</label>
                            <input type="text" class="form-control" id="state" name="state" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="country" class="form-label">Country</label>
                            <input type="text" class="form-control" id="country" name="country" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="state_code" class="form-label">State Code</label>
                            <input type="text" class="form-control" id="state_code" name="state_code" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="gstin" class="form-label">GSTIN</label>
                            <input type="text" class="form-control" id="gstin" name="gstin" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="phone" class="form-label">Phone</label>
                            <input type="text" class="form-control" id="phone" name="phone">
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="mobile" class="form-label"><span style="color: red;">*</span>  Mobile</label>
                            <input type="text" class="form-control" id="mobile" name="mobile" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="email" class="form-label"><span style="color: red;">*</span> Email</label>
                            <input type="text" class="form-control" id="email" name="email" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="fax" class="form-label">Fax</label>
                            <input type="text" class="form-control" id="fax" name="fax" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="tax_id" class="form-label">Tax ID</label>
                            <input type="text" class="form-control" id="tax_id" name="tax_id" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="contact_person" class="form-label"><span style="color: red;">*</span> Contact Person</label>
                            <input type="text" class="form-control" id="contact_person" name="contact_person" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="cp_phone" class="form-label">Contact Person Phone</label>
                            <input type="text" class="form-control" id="cp_phone" name="cp_phone" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="cp_mobile" class="form-label">Contact Person Mobile</label>
                            <input type="text" class="form-control" id="cp_mobile" name="cp_mobile" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="cp_email" class="form-label">Contact Person Email</label>
                            <input type="text" class="form-control" id="cp_email" name="cp_email" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="report_email" class="form-label">Report Email</label>
                            <input type="text" class="form-control" id="report_email" name="report_email" >
                        </div>
                        
                        
                        <div class="col-md-4 mb-1">
                            <label for="logo" class="form-label"><span style="color: red;">*</span> Logo</label>
                            <input type="file" class="form-control" id="logo" name="logo" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="logo_small" class="form-label"><span style="color: red;">*</span> Logo Small</label>
                            <input type="file" class="form-control" id="logo_small" name="logo_small" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="logo_invoice" class="form-label"><span style="color: red;">*</span> Logo Invoice</label>
                            <input type="file" class="form-control" id="logo_invoice" name="logo_invoice" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="opening_balance" class="form-label">Opening Balance</label>
                            <input type="number" class="form-control" id="opening_balance" name="opening_balance" value="{{company.opening_balance}}">
                        </div>
                        
                        <div class="col-md-4 mb-1">
                            <label for="latitude" class="form-label">Latitude</label>
                            <input type="text" class="form-control" id="latitude" name="latitude" >
                        </div>
                        <div class="col-md-4 mb-1">
                            <label for="longitude" class="form-label">Longitude</label>
                            <input type="text" class="form-control" id="longitude" name="longitude">
                        </div>
                        <hr>
                        <h5><label for="mail" class="form-label">Primary Technician Details</label></h5>
                        <div class="row">
                            <div class="col-3 mb-3">
                                <label for="person" class="form-label"><span style="color: red;">*</span> Name</label>
                                <input class="form-control" type="text" id="person" name="person">
                            </div>
                            <div class="col-3 mb-3">
                                <label for="phone" class="form-label"><span style="color: red;">*</span> Phone Number</label>
                                <input class="form-control" type="text" id="phone" name="phone">
                            </div>   
                            <div class="col-3 mb-3">
                                <label for="mail" class="form-label"><span style="color: red;">*</span> Email Address</label>
                                <input class="form-control" type="email" id="mail" name="mail">
                            </div>
                            <div class="col-3 mb-3">
                                <label for="name" class="form-label"><span style="color: red;">*</span> Password</label>
                                <input class="form-control" type="password" id="password" name="password">
                            </div>      
                        </div>
                        <div class="col-12 d-flex justify-content-end"> 
                            <input type="hidden" name="id" id="edit_id" >
                            <button class="btn btn-secondary me-2" type="reset">Clear</button> 
                            <button class="btn btn-success" type="button" id="updateBtn">Add</button>
                        </div>
                    </form>
                </div>

            </div>
        </div>
    </div>
</div>
<!-- End of Content -->
{% include 'includes/includes_admin/footer.html' %}
<script type="text/javascript">
    $(document).ready(function() {
        $('#updateBtn').on('click', function(event) {
            event.preventDefault();

            // Check for required fields with the red asterisk (*)
            var isValid = true;
            $('#edit_form .form-control').each(function() {
                // Only check the fields that are required (marked with red *)
                if ($(this).closest('div').find('span').length > 0) {
                    if ($(this).val() === '') {
                        isValid = false;
                        $(this).addClass('is-invalid');  // Add bootstrap invalid class
                    } else {
                        $(this).removeClass('is-invalid');  // Remove invalid class if filled
                    }
                }
            });

            // If validation fails, show a message and stop the form submission
            if (!isValid) {
                showToast('error', 'Please fill all required fields!');
                return;  // Prevent the form submission
            }

            // If validation passes, submit the form
            var formData = new FormData($('#edit_form')[0]);
            $.ajax({
                type: 'POST',
                url: '/add_company_details/',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.message === 'success') {
                        sessionStorage.setItem('addSuccessMessage', true);
                        window.location.href = '/company';
                    } else if (response.error_message) {
                        showToast('warning', 'Access Denied! You do not have permission to update company details');
                    } else {
                        showToast('error', 'Failed to update company details');
                    }
                },
                error: function(xhr, errmsg, err) {
                    console.log(xhr.status + ": " + xhr.responseText);
                }
            });
        });
    });

    // Function to show toast messages
    
</script>
