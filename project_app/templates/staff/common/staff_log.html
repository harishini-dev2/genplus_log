{% load static %}
{% include 'includes/includes_staff/headers.html' %}
{% include 'includes/includes_staff/sidebar.html' %}
{% include 'includes/includes_staff/navbar.html' %}
<!-- Content Here -->

<div class="page-wrapper">
    <div class="page-content">
        <div class="dash-wrapper">
            <div class="page-breadcrumb d-none d-sm-flex align-items-centers-center mb-4">
                <div class="breadcrumb-title pe-3">Staff Log</div>
                <div class="ps-3">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0 p-0">
                            <li class="breadcrumb-item"><a href="javascript:;"><i class="bx bx-home-alt"></i></a></li>
                            <li class="breadcrumb-item active" aria-current="page">Staff Log &nbsp
                                <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#add_modal">Add</button>
                                <button type="button" class="btn btn-sm btn-primary" onclick="refresh_data()">Refresh</button>
                            </li>
                        </ol>
                    </nav>
                </div>               
            </div> 

            <div class="row">                
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">  
                        <div class="row">                      

                            <div class="col-3 mb-3">
                                <label for="name" class="control-label mb-2">
                                    <input type="checkbox" id="is_date" checked> Date Filter
                                </label>
                                <div id="reportrange"
                                    style="background: #fff; cursor: pointer; padding: 5px 9px; border: 1px solid #ccc; width: 100%; height: auto; border-radius: 4px;">
                                    <i class="fa fa-calendar"></i> &nbsp;
                                    <span></span> <i class="fa fa-caret-down"></i>
                                </div>
                            </div>

                            <div class="col-2 mb-3">
                                <label for="name" class="form-label">Project</label>
                                <select class="form-control single-select" id="filter_project"
                                    name="category">
                                    <option value="">Select</option>
                                    
                                </select>
                            </div>

                            <div class="col-2 mb-3">
                                <label for="name" class="form-label">Task</label>
                                <select class="form-control single-select" id="filter_task"
                                    name="category">
                                    <option value="">Select</option>
                                    
                                </select>
                            </div>

                            <div class="col-2 mb-3">
                                <label for="name" class="form-label">Project Status</label>
                                <select class="form-control single-select" id="filter_status"
                                    name="category">
                                    <option value="pending">Pending</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="on_hold">On Hold</option>                 
                                    <option value="completed">Completed</option>
                                </select>
                            </div>

                           
                        </div> 


                            <div class="table-responsive mt-4">
                                <table id="datatable" class="table table-striped table-bordered nowrap">
                                    {% csrf_token %}
                                    <thead>
                                        <tr>
                                            <th>ID #</th>
                                            <th>Action</th>
                                            <th>From Date</th>
                                            <th>To Date</th>
                                            <th>Start Time</th>
                                            <th>End Time</th>
                                            <th>Project</th>
                                            <th>Task</th>
                                            <th>Task Descriptions</th>
                                            <th>Issue Descriptions</th>
                                            <th>Approved</th>
                                            <th>Task Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>                            
                                    </tbody>
                                </table>  
                            </div> 
                                                 
                        </div>
                    </div>
                </div>
            </div>


            <div class="modal fade" id="add_modal" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h6 class="modal-title" id="staticBackdropLabel">Add Log</h6>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="add_form">
                                <div class="modal-body">
                                    {% csrf_token %}                                            
                                    <div class="row">
                                        <div class="col-6 mb-4">
                                            <label for="edit_name" class="form-label">From Date</label>
                                            <input class="form-control" type="date" id="from_date" name="from_date">
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="edit_name" class="form-label">To Date</label>
                                            <input class="form-control" type="date" id="to_date" name="to_date">
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="edit_name" class="form-label">Start Time</label>
                                            <input class="form-control" type="time" id="start_time" name="start_time">
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="edit_name" class="form-label">End Time</label>
                                            <input class="form-control" type="time" id="end_time" name="end_time">
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="edit_name" class="form-label">Project</label>
                                            <select class=" form-control single-select" id="project_id" name="project_id">
                                                <option value="">Select</option>
                                            </select>
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="edit_name" class="form-label">Task</label>
                                            <select class=" form-control single-select" id="task_id" name="task_id">
                                                <option value="">Select</option>
                                            </select>
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="edit_name" class="form-label">File</label>
                                            <input class="form-control" type="file" id="file" name="file">
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="task_status" class="form-label">Status</label> 
                                            <select class=" form-control single-select" id="task_status" name="task_status">
                                                <option value="">Select</option>
                                                <option value="pending" selected>Pending</option>
                                                <option value="in_progress">In Progress</option>
                                                <option value="on_hold">On Hold</option>                 
                                                <option value="completed">Completed</option>                 
                                            </select> 
                                        </div>
                                       
                                        <div class="col-6 mb-4">
                                            <label for="description" class="form-label">Task Description</label>
                                            <textarea class="form-control" id="task_descriptions" rows="4" name="task_descriptions"></textarea>
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="description" class="form-label">Issue Description</label>
                                            <textarea class="form-control" id="issue_descriptions" rows="4" name="issue_descriptions"></textarea>
                                        </div>
                                    </div> 
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-success">save</button>
                                </div>
                            </form>
                        </div>                   
                    </div>
                </div>
            </div>


            <div class="modal fade" id="edit_modal"  aria-labelledby="staticBackdropLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h6 class="modal-title" id="staticBackdropLabel">Edit Log</h6>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <form id="edit_form">
                                <div class="modal-body">
                                    {% csrf_token %}                                            
                                    <div class="row">
                                        <div class="col-6 mb-4">
                                            <label for="edit_name" class="form-label">From Date</label>
                                            <input class="form-control" type="date" id="edit_from_date" name="from_date">
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="edit_name" class="form-label">To Date</label>
                                            <input class="form-control" type="date" id="edit_to_date" name="to_date">
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="edit_name" class="form-label">Start Time</label>
                                            <input class="form-control" type="time" id="edit_start_time" name="start_time">
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="edit_name" class="form-label">End Time</label>
                                            <input class="form-control" type="time" id="edit_end_time" name="end_time">
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="edit_name" class="form-label">Project</label>
                                            <select class=" form-control single-select" id="edit_project_id" name="project_id">
                                            </select>
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="edit_name" class="form-label">Task</label>
                                            <select class=" form-control single-select" id="edit_task_id" name="task_id">
                                            </select>
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="edit_name" class="form-label">File</label>
                                            <input class="form-control" type="file" id="edit_file" name="file">
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="task_status" class="form-label">Status</label> 
                                            <select class=" form-control single-select" id="edit_task_status" name="task_status">
                                                <option value="pending">Pending</option>
                                                <option value="in_progress">In Progress</option>
                                                <option value="on_hold">On Hold</option>                 
                                                <option value="completed">Completed</option>                 
                                            </select> 
                                        </div>
                                       
                                        <div class="col-6 mb-4">
                                            <label for="description" class="form-label">Task Description</label>
                                            <textarea class="form-control" id="edit_task_descriptions" rows="4" name="task_descriptions"></textarea>
                                        </div>
                                        <div class="col-6 mb-4">
                                            <label for="description" class="form-label">Issue Description</label>
                                            <textarea class="form-control" id="edit_issue_descriptions" rows="4" name="issue_descriptions"></textarea>
                                        </div>
                                    </div> 
                                </div>
                                <div class="modal-footer">
                                    <input type="hidden" name="id" id="edit_id">
                                    <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
                                    <button type="submit" class="btn btn-success">save</button>
                                </div>
                            </form>
                        </div>                   
                    </div>
                </div>
            </div>
            


        </div>
    </div>
</div>
<!-- End of Content -->
{% include 'includes/includes_staff/footer.html' %}


<script>

    var currentDate = new Date().toISOString().split('T')[0];
    document.getElementById('from_date').value = currentDate;
    document.getElementById('to_date').value = currentDate;


    



  


    $("#add_form").submit(function (e) {
        e.preventDefault();
        
        // Validation: Check if any required field is empty
        var isValid = true;
        var missingFields = [];
        
        // Check if any field is empty
        if ($('#from_date').val() === "") {
            isValid = false;
            missingFields.push("From Date");
        }
        if ($('#to_date').val() === "") {
            isValid = false;
            missingFields.push("To Date");
        }
        if ($('#start_time').val() === "") {
            isValid = false;
            missingFields.push("Start Time");
        }
        if ($('#end_time').val() === "") {
            isValid = false;
            missingFields.push("End Time");
        }
        if ($('#project_id').val() === "") {
            isValid = false;
            missingFields.push("Project");
        }
        if ($('#task_id').val() === "") {
            isValid = false;
            missingFields.push("Task");
        }
        
        if ($('#task_status').val() === "") {
            isValid = false;
            missingFields.push("Status");
        }



        if (!isValid) {
            showToast('warning', 'Please fill the following fields: ' + missingFields.join(', '));
            return; 
        }

        var formData = new FormData(this);
    

        $.ajax({
            type: 'POST',
            url: '/log_add/',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                if (response.message === 'error') {
                    showToast('warning', 'Access Denied! You do not have permission to add details');
                    $(modalToClose).modal('hide');
                } else if (response.message === 'success') {

                    showToast('success', 'Log Created successfully');
                    $('#project_id').val('').trigger('change');
                    $('#task_id').val('').trigger('change');
                    $('#task_status').val('pending').trigger('change');

                    $('#add_modal').modal('hide');
                    $('#add_form').trigger('reset');
                    var currentDate = new Date().toISOString().split('T')[0];
                    document.getElementById('from_date').value = currentDate;
                    document.getElementById('to_date').value = currentDate;

                    table.ajax.reload();
                } else {
                    showToast('error', 'Failed to add log');
                    $(modalToClose).modal('hide');
                }
            },
            error: function (xhr, errmsg, err) {
                showToast('error', 'An error occurred while processing');
                console.log(xhr.status + ": " + xhr.responseText);
            }
        });
    });



    $("#edit_form").submit(function (e) {
        e.preventDefault();
        var isValid = true;
        var missingFields = [];
        
        // Check if any field is empty
        if ($('#edit_from_date').val() === "") {
            isValid = false;
            missingFields.push("From Date");
        }
        if ($('#edit_to_date').val() === "") {
            isValid = false;
            missingFields.push("To Date");
        }
        if ($('#edit_start_time').val() === "") {
            isValid = false;
            missingFields.push("Start Time");
        }
        if ($('#edit_end_time').val() === "") {
            isValid = false;
            missingFields.push("End Time");
        }
        if ($('#edit_project_id').val() === "") {
            isValid = false;
            missingFields.push("Project");
        }
        if ($('#edit_task_id').val() === "") {
            isValid = false;
            missingFields.push("Task");
        }
        
        if ($('#edit_task_status').val() === "") {
            isValid = false;
            missingFields.push("Status");
        }



        if (!isValid) {
            showToast('warning', 'Please fill the following fields: ' + missingFields.join(', '));
            return; 
        }

        var formData = new FormData(this);
        $.ajax({
            type: 'POST',
            url: '/log_update/',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) { 
                if (response.message === 'error') { 
                    showToast('warning','Access Denied! You do not have permission to update');
                    
                    $('#edit_modal').modal('hide');                  
                }

                else if (response.message === 'success') {
                    showToast('success','Log updated successfully');                    
                    $('#edit_modal').modal('hide');
                    $('#edit_form')[0].reset();  
                    table.ajax.reload();
                } else {
                    showToast('error','Failed to update Log');               
                    $('#edit_modal').modal('hide');
                }
            },
            error: function(xhr, errmsg, err){
                showToast('error',"failed to update")
                console.log(xhr.status + ": " + xhr.responseText);
            }
        });
    });



    function refresh_data(){
        table.ajax.reload();
    }


</script>

<script>


$(document).ready(function() {
    function populateProjects() {
        $.ajax({
            url: '/staff_projects/',
            type: 'GET',
            success: function(response) {
                var projects = response.projects;
                
                var $selectAdd = $('#project_id');
                var $selectEdit = $('#edit_project_id');
                var $selectFilter = $('#filter_project');
                
                $selectAdd.empty();
                $selectEdit.empty();
                $selectFilter.empty();
                
                $selectAdd.append('<option value="">Select</option>');
                $selectEdit.append('<option value="">Select</option>');
                $selectFilter.append('<option value="">Select</option>');

                projects.forEach(function(project) {
                    var option = '<option value="' + project.id + '">' + project.name + '</option>';
                    $selectAdd.append(option);
                    $selectEdit.append(option);
                    $selectFilter.append(option);
                });
            },
            error: function(error) {
                console.log("Error fetching projects: ", error);
            }
        });
    }

    populateProjects();
});




function loadtask(projectDropdownId, taskDropdownId) {
    $(projectDropdownId).change(function () {
        var projectId = $(this).val();

        // Check if the selected project ID is valid
        if (projectId && projectId !== "Select") {
            $.ajax({
                url: '/staff_task/' + projectId + '/',
                type: 'GET',
                success: function (response) {
                    var taskDropdown = $(taskDropdownId);
                    taskDropdown.empty();
                    taskDropdown.append('<option value="">Select</option>');
                    response.tasks.forEach(function (task) {
                        taskDropdown.append('<option value="' + task.id + '">' + task.task_name + '-' + task.task_code + '</option>');
                    });

                    // Check if a specific task ID is pre-selected
                    var preselectedTaskId = taskDropdown.data('preselected');
                    if (preselectedTaskId) {
                        taskDropdown.val(preselectedTaskId).trigger('change');
                        // Clear the preselected data to avoid repeated application
                        taskDropdown.data('preselected', null);
                    }
                },
                error: function () {
                    console.error('Error loading tasks.');
                }
            });
        } else {
            // Clear task dropdown if the project selection is invalid
            $(taskDropdownId).empty().append('<option value="">Select</option>');
        }
    });
}

$(document).ready(function () {
    loadtask('#project_id', '#task_id');
    loadtask('#edit_project_id', '#edit_task_id');
    loadtask('#filter_project', '#filter_task');
});



function log_edit(id, name) {
 var tkn = document.getElementsByName("csrfmiddlewaretoken")[0].value;
 $.post('/log_edit/', {id: id, csrfmiddlewaretoken: tkn}, function(res) {
     $('#edit_id').val(res.id);
        $('#edit_from_date').val(res.start_date);
        $('#edit_to_date').val(res.to_date);
        $('#edit_start_time').val(res.start_time);
        $('#edit_end_time').val(res.end_time);

        $('#edit_project_id').val(res.project_id).trigger('change');

        $('#edit_task_id').data('preselected', res.task_id);

        $('#edit_task_status').val(res.task_status).trigger('change');
        $('#edit_task_descriptions').val(res.task_descriptions);
        $('#edit_issue_descriptions').val(res.issue_descriptions);      
     $('#edit_modal').modal('show');
 });
}


function log_delete(id) {
    if (confirm('Are you sure you want to delete this data?')) {
        $.ajax({
            url: "/log_delete/",
            method: "POST",
            data: { 
                id: id, 
                csrfmiddlewaretoken: '{{ csrf_token }}' 
            },
            dataType: "json",

            success: function(data) {
                if (data.message === 'error') {  
                    showToast('warning','Access Denied!,You do not have permission to delete log details ');                        
                                    
                } else if (data.message === 'yes') {
                    showToast('success','Log details deleted successfully')
                
                    table.ajax.reload();
                } else {
                    showToast('error','Failed to delete log')
                    
                }
            }
            
        });

    }
}


    var start_date;
    var end_date;

    function cb(start, end) {
        $('#reportrange span').html(start.format('YYYY-MM-DD') + ' - ' + end.format('YYYY-MM-DD'));
        start_date = start.format('YYYY-MM-DD');
        end_date = end.format('YYYY-MM-DD');
    }

    $('#reportrange').daterangepicker({
        startDate: moment().startOf('month'),
        endDate: moment().endOf('month'),
        ranges: {
            'Today': [moment(), moment()],
            'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
            'Last 7 Days': [moment().subtract(6, 'days'), moment()],
            'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
            'This Month': [moment().startOf('month'), moment().endOf('month')],
            'Next Month': [moment().add(1, 'month').startOf('month'), moment().add(1, 'month').endOf('month')]
        }
    }, cb);

    cb(moment().startOf('month'), moment().endOf('month'));

    $('#reportrange').on('apply.daterangepicker', function (ev, picker) {
        table.ajax.reload();
    });



       var table = $('#datatable').DataTable({
        "processing": true,
        "pageLength": 50,
        "destroy": true,
        "order": [],
		 "dom": 'Bfrtip',
            buttons: [
                {
                    extend: 'excelHtml5',
                    customize: function (xlsx) {
                        var sheet = xlsx.xl.worksheets['sheet1.xml'];
                        $('row c[r^="F"]', sheet).each(function () {
                            if ($('is t', this).text().replace(/[^\d]/g, '') * 1 >= 500000) {
                                $(this).attr('s', '20');
                            }
                        });
                    }
                }
            ],
        "columns": [
            { "data": "id", "title": " ID #" },
            { "data": "action", "title": "Action" }, 
            { "data": "from", "title": " From date" },
            { "data": "to", "title": " To Date" },
            { "data": "start", "title": " Start Time" },
            { "data": "end", "title": "End Time" },
            { "data": "project", "title": "Project" },
            { "data": "task", "title": "Task" },
            { "data": "desc", "title": "Task descriptions" },
            { "data": "issue", "title": "Issue descriptions" },
            { "data": "approve", "title": "Approved" },
            { "data": "status", "title": "Task Status" },
        ], 
        "ajax": {
            "url": '/log_view/',
            "type": "POST",
            "data": function(data){
                data.csrfmiddlewaretoken = document.getElementsByName("csrfmiddlewaretoken")[0].value;
                data.project = $('#filter_project').val();
                data.task = $('#filter_task').val();
                data.status = $('#filter_status').val();
                if (start_date && end_date && $('#is_date').is(":checked")) {
                    data.from_date = start_date;
                    data.to_date = end_date;
                }
            },
            "dataSrc": function(json) {
                if (json.message === 'error') {
                    
                    console.log('access denied')
                    return [];
                }

                // Log and return the valid data
                console.log(json);
                return json.data;
            }
        }
    });

   



</script>